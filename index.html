<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Countdown Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Inter font and new custom fonts -->
    <style>
        /* Including Inter, Mountains of Christmas, and Roboto for font options */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Mountains+of+Christmas:wght@400;700&family=Roboto:wght@700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fce7f3; /* Light Pink/Snowy Background */
        }
        /* Custom font for a festive feel */
        .christmas-font {
            font-family: 'Mountains of Christmas', cursive;
        }
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3e%3cpath d='M7 10l5 5 5-5H7z' fill='%2310B981'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.8em 0.8em;
        }
        /* CSS variable for controlling preview aspect ratio */
        .ratio-container {
            /* Fallback ratio for when JS hasn't run yet (1:1 square) */
            aspect-ratio: 1 / 1; 
            height: auto; /* Allow height to adjust based on aspect-ratio and width */
        }
        /* Custom style for locked controls - retained but now effectively hidden by 'hidden' */
        .locked-controls {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Main Content Card -->
    <div class="w-full max-w-sm bg-white shadow-2xl rounded-xl p-6 md:p-10 border-4 border-red-600">
        
        <!-- Title -->
        <h1 id="countdownTitle" class="text-4xl christmas-font text-center font-bold text-red-700 mb-4">
            Christmas Countdown Generator
        </h1>
        
        <!-- Live Countdown Bar (UPDATED: Red color, Inter font, larger text) -->
        <div id="liveCountdownBar" class="text-center bg-red-600 text-white p-3 rounded-xl shadow-lg mb-6 transition-all duration-300">
            Loading countdown...
        </div>

        <!-- Tab Navigation (Two Main Tabs: Holiday Selector and Custom Date) -->
        <div class="flex border-b border-gray-200 mb-6" id="selectionTabs">
            <button id="tab-preset_holiday" 
                    onclick="switchTab('preset_holiday')"
                    class="tab-button w-1/2 py-2 text-sm font-semibold text-center border-b-2 transition duration-150 ease-in-out">
                üéÅ Select Holiday
            </button>
            <button id="tab-custom_date"
                    onclick="switchTab('custom_date')"
                    class="tab-button w-1/2 py-2 text-sm font-semibold text-center border-b-2 transition duration-150 ease-in-out">
                Custom Date
            </button>
        </div>

        <!-- Tab Content Container -->
        <div id="tabContent">
            
            <!-- 1. Preset Holiday Content (Dropdown) -->
            <div id="content-preset_holiday" class="tab-content hidden w-full space-y-4 pt-4">
                <label for="holiday-select" class="w-full text-left text-sm font-semibold text-gray-700">Choose a Holiday:</label>
                <select id="holiday-select" onchange="handleHolidaySelection(this.value)" 
                        class="custom-select block w-full border border-gray-300 rounded-lg p-3 text-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                    <!-- Options populated by JS -->
                </select>
            </div>
            
            <!-- 2. Custom Date Tab Content -->
            <div id="content-custom_date" class="tab-content hidden w-full space-y-4 pt-4">
                <label for="custom-target-date" class="w-full text-left text-sm font-semibold text-gray-700">Set Target Date:</label>
                <input type="date" id="custom-target-date" 
                        class="block w-full border border-gray-300 rounded-lg p-3 text-lg focus:ring-red-500 focus:border-red-500 transition duration-150"
                        onchange="updatePreviewSize()">

                <!-- Custom Countdown Label Input -->
                <label for="custom-target-date-label" class="w-full text-left text-sm font-semibold text-gray-700">Custom Countdown Label (e.g., Birthday, Trip):</label>
                <input type="text" id="custom-target-date-label" placeholder="Target Date"
                        class="block w-full border border-gray-300 rounded-lg p-3 text-lg focus:ring-red-500 focus:border-red-500 transition duration-150"
                        oninput="updatePreviewSize()">
            </div>
            
        </div>
        <!-- End Tab Content -->

        <p class="text-center text-gray-600 text-sm mb-6">
            Your static countdown image preview is below. Select your download options!
        </p>

        <!-- Canvas Container -->
        <div id="canvasContainer" class="flex justify-center items-center w-full ratio-container border-2 border-dashed border-green-500 rounded-lg overflow-hidden">
            <canvas id="countdownCanvas" class="w-full h-full"></canvas>
        </div>

        <!-- Download Options and Button -->
        <div class="mt-8 flex flex-col space-y-4 items-center w-full">
            
            <!-- Advanced Options Button -->
            <button id="advancedOptionsButton"
                    class="christmas-font bg-red-600 hover:bg-red-700 text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 w-full"
                    onclick="toggleAdvancedOptions()">
                Advanced Options
            </button>

            <!-- Advanced Options Dropdowns Container -->
            <div id="advancedOptionsContainer" class="hidden w-full space-y-4 pt-4 border-t border-gray-200">
                
                <!-- Customization Fields (Font and Color) -->
                <div id="colorFontControls" class="w-full space-y-4 pt-4 border-t border-gray-200 transition-opacity duration-300">
                    <label class="w-full text-left text-sm font-semibold text-gray-700">Customize Colors & Font:</label>

                    <label for="custom-bg-color" class="block text-sm font-medium text-gray-700">Background Color</label>
                    <input type="color" id="custom-bg-color" value="#B91C1C" oninput="updatePreviewSize()" 
                           class="block w-full h-10 border border-gray-300 rounded-lg p-1">

                    <label for="custom-number-color" class="block text-sm font-medium text-gray-700">Number/Border Color</label>
                    <input type="color" id="custom-number-color" value="#17a34a" oninput="updatePreviewSize()" 
                           class="block w-full h-10 border border-gray-300 rounded-lg p-1">
                           
                    <label for="custom-font-select" class="block text-sm font-medium text-gray-700">Font Style</label>
                    <select id="custom-font-select" onchange="updatePreviewSize()" 
                            class="custom-select block w-full border border-gray-300 rounded-lg p-3 text-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                        <option value="'Mountains of Christmas', cursive" selected>Mountains of Christmas (Festive)</option>
                        <option value="'Inter', sans-serif">Inter (Modern)</option>
                        <option value="'Roboto', sans-serif">Roboto (Clean)</option>
                        <option value="'serif'">Serif (Classic)</option>
                    </select>
                </div>
                
                <!-- Passcode to Unlock Custom Days -->
                <label for="passcode-input" class="w-full text-left text-sm font-semibold text-gray-700">Enter Passcode to unlock Custom Days:</label>
                <div class="flex space-x-2">
                    <input type="text" id="passcode-input" placeholder="Passcode" 
                           class="block w-3/4 border border-gray-300 rounded-lg p-3 text-lg focus:ring-red-500 focus:border-red-500 transition duration-150">
                    <button onclick="checkPasscode()" 
                            class="w-1/4 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg text-sm">
                        Unlock
                    </button>
                </div>
                
                <!-- Custom Days Input (Initially Hidden) -->
                <div id="customDaysContainer" class="hidden w-full space-y-4 pt-2">
                    <label for="custom-days-input" class="w-full text-left text-sm font-semibold text-gray-700">Set Custom Days Remaining:</label>
                    <input type="number" id="custom-days-input" min="0" max="366" value="80" 
                           class="block w-full border border-gray-300 rounded-lg p-3 text-lg focus:ring-green-500 focus:border-green-500 transition duration-150"
                           oninput="updatePreviewSize()">
                </div>

                <!-- Resolution Selector -->
                <label for="resolution-select" class="w-full text-left text-sm font-semibold text-gray-700">Select Resolution (for download):</label>
                <select id="resolution-select" 
                        class="custom-select block w-full border border-gray-300 rounded-lg p-3 text-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    <option value="540x540">Square (540 x 540)</option>
                    <option value="1080x1080" selected>Square (1080 x 1080)</option>
                    <option value="1080x1920">YouTube Short (1080 x 1920)</option>
                    <option value="1500x1500">Square (1500 x 1500)</option>
                    <option value="2160x2160">Square (4K)</option>
                </select>

                <!-- File Type Selector -->
                <label for="filetype-select" class="w-full text-left text-sm font-semibold text-gray-700">Select File Type:</label>
                <select id="filetype-select" 
                        class="custom-select block w-full border border-gray-300 rounded-lg p-3 text-lg focus:ring-green-500 focus:border-green-500 transition duration-150">
                    <option value="png" selected>PNG (High Quality)</option>
                    <option value="jpeg">JPEG (Smaller File Size)</option>
                </select>
            </div>
            
            <!-- Download Button -->
            <button id="downloadButton"
                    class="christmas-font bg-green-600 hover:bg-green-700 text-white text-xl font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105 w-full"
                    onclick="downloadImage()">
                Download Countdown Image
            </button>
        </div>

    </div>

    <script type="text/javascript">
        // Global canvas variables for preview
        let canvas, ctx, resolutionSelect, customDaysInput;
        // Global state to track the active selection mode: 'preset_holiday' or 'custom_date'
        let currentSelectionMode = 'preset_holiday'; 
        // Global state to track the specific holiday key when in 'preset_holiday' mode
        let currentHolidayKey = 'christmas'; 
        // Global state to track if the passcode has been successfully entered
        let isPasscodeUnlocked = false;
        // Global variable for the live countdown timer
        let countdownInterval; 
        
        // Define configuration for different holidays
        const HolidayConfigs = {
            // Fixed Date Holidays
            christmas: { type: 'fixed', month: 11, day: 25, defaultBg: '#B91C1C', defaultBorder: '#17a34a', title: "CHRISTMAS", text: "UNTIL CHRISTMAS!" },
            new_years: { type: 'fixed', month: 0, day: 1, defaultBg: '#1E40AF', defaultBorder: '#FBBF24', title: "NEW YEAR'S", text: "UNTIL NEW YEAR'S!" },
            halloween: { type: 'fixed', month: 9, day: 31, defaultBg: '#F97316', defaultBorder: '#1F2937', title: "HALLOWEEN", text: "UNTIL HALLOWEEN!" },
            valentines: { type: 'fixed', month: 1, day: 14, defaultBg: '#EC4899', defaultBorder: '#FFFFFF', title: "VALENTINE'S DAY", text: "UNTIL VALENTINE'S DAY!" },

            // Dynamic Date Holidays (Month is 0-indexed, DayOfWeek is 0=Sun to 6=Sat)
            thanksgiving: { type: 'dynamic', month: 10, week: 4, dayOfWeek: 4, defaultBg: '#8B5CF6', defaultBorder: '#D97706', title: "THANKSGIVING", text: "UNTIL THANKSGIVING!" }, // 4th Thursday of November
            wzyn_jubilee: { type: 'dynamic', month: 2, week: 2, dayOfWeek: 6, defaultBg: '#4C51BF', defaultBorder: '#FBBF24', title: "WZYN JUBILEE", text: "UNTIL WZYN JUBILEE!" }, // 2nd Saturday of March
            
            // Custom Date (used when custom_date tab is active)
            custom_date: { type: 'custom', defaultBg: '#374151', defaultBorder: '#FBBF24', title: "CUSTOM DATE", text: "UNTIL TARGET DATE!" }
        };
        
        // Constant array of all preset holiday keys
        const PRESET_HOLIDAY_KEYS = Object.keys(HolidayConfigs).filter(key => key !== 'custom_date');

        /**
         * Calculates the date for a dynamic holiday (e.g., 4th Thursday of November).
         */
        function getDynamicHolidayDate(year, monthIndex, weekNumber, dayOfWeek) {
            let date = new Date(year, monthIndex, 1);
            
            while (date.getDay() !== dayOfWeek) {
                date.setDate(date.getDate() + 1);
            }
            
            date.setDate(date.getDate() + (weekNumber - 1) * 7);
            return date;
        }

        /**
         * Helper function to get the precise future target Date object.
         * Handles year rollover for non-custom dates.
         * @returns {Date | null} The target date object, or null if invalid/missing.
         */
        function getTargetDate() {
            const holidayKey = getActiveHolidayKey();
            const config = HolidayConfigs[holidayKey];
            if (!config) return null;

            const today = new Date();
            const currentYear = today.getFullYear();
            let targetDate;

            if (config.type === 'custom') {
                const customDateString = document.getElementById('custom-target-date').value;
                if (!customDateString) return null;
                // Use custom date input, setting time to midnight (00:00:00)
                targetDate = new Date(customDateString + 'T00:00:00'); 
            } else if (config.type === 'fixed') {
                targetDate = new Date(currentYear, config.month, config.day);
            } else if (config.type === 'dynamic') {
                targetDate = getDynamicHolidayDate(currentYear, config.month, config.week, config.dayOfWeek);
            } else {
                return null; // Unknown type
            }
            
            // Check for year rollover for non-custom dates
            // If the target date is in the past, roll it over to next year
            if (config.type !== 'custom' && today.getTime() > targetDate.getTime()) {
                if (config.type === 'fixed') {
                    targetDate.setFullYear(currentYear + 1);
                } else if (config.type === 'dynamic') {
                    // Recalculate dynamic date for the next year
                    targetDate = getDynamicHolidayDate(currentYear + 1, config.month, config.week, config.dayOfWeek);
                }
            }

            return targetDate;
        }

        /**
         * Calculates the number of full days until the selected holiday.
         * Used for the static canvas display.
         * @returns {number} The number of days remaining.
         */
        function calculateDaysUntilHoliday() {
            // 1. Check for custom day count override
            const customDaysContainer = document.getElementById('customDaysContainer');
            if (!customDaysContainer.classList.contains('hidden')) {
                const customValue = parseInt(customDaysInput.value);
                if (!isNaN(customValue) && customValue >= 0) {
                    return customValue;
                }
            }
            
            const targetDate = getTargetDate(); // Use the new function to get the correct future date
            if (!targetDate) return 0;

            const today = new Date();
            
            // Normalize dates to midnight for accurate full-day calculation (floor/ceil is safer)
            const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
            const holidayMidnight = new Date(targetDate.getFullYear(), targetDate.getMonth(), targetDate.getDate()).getTime();

            if (todayMidnight >= holidayMidnight) {
                return 0;
            }

            // Calculate the difference in full days
            const diffTime = holidayMidnight - todayMidnight;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return Math.max(0, diffDays);
        }

        /**
         * Updates the live countdown display in the top bar every second.
         */
        function updateLiveCountdown() {
            const targetDate = getTargetDate();
            const now = new Date().getTime();
            const countdownBar = document.getElementById('liveCountdownBar');

            if (!targetDate || now >= targetDate.getTime()) {
                if (countdownInterval) clearInterval(countdownInterval);
                countdownBar.innerHTML = '<span class="text-xl font-bold">üéâ Holiday is TODAY! Have Fun! üéâ</span>';
                return;
            }

            const distance = targetDate.getTime() - now;

            // Time constants
            const oneSecond = 1000;
            const oneMinute = oneSecond * 60;
            const oneHour = oneMinute * 60;
            const oneDay = oneHour * 24;

            // Calculate remaining time components
            let remainingDays = Math.floor(distance / oneDay);
            let remainingHours = Math.floor((distance % oneDay) / oneHour);
            let remainingMinutes = Math.floor((distance % oneHour) / oneMinute);
            let remainingSeconds = Math.floor((distance % oneMinute) / oneSecond);

            // Approximate Month Calculation (30 days)
            const approxMonths = Math.floor(remainingDays / 30);
            const displayDays = remainingDays % 30; 

            // Helper for consistent unit formatting (UPDATED: Larger font for Inter)
            const formatUnit = (value, unit) => {
                const plural = value === 1 ? '' : 's';
                return `<div><span class="font-black text-2xl">${value}</span><br><span class="text-sm font-semibold">${unit}${plural}</span></div>`;
            };
            
            // Build the HTML for the countdown bar
            const countdownHTML = `
                <div class="flex justify-center space-x-2 md:space-x-4">
                    ${formatUnit(approxMonths, 'Month')}
                    ${formatUnit(displayDays, 'Day')}
                    ${formatUnit(remainingHours, 'Hour')}
                    ${formatUnit(remainingMinutes, 'Min')}
                    ${formatUnit(remainingSeconds, 'Sec')}
                </div>
            `;

            countdownBar.innerHTML = countdownHTML;
        }

        // The SECRET_PASSCODE is "1041"
        const SECRET_PASSCODE = "1041"; 

        // --- UI State Management ---
        
        /**
         * Determines the active holiday key based on the current selection mode.
         * @returns {string} The active holiday key (e.g., 'christmas' or 'custom_date').
         */
        function getActiveHolidayKey() {
             return currentSelectionMode === 'custom_date' ? 'custom_date' : currentHolidayKey;
        }

        /**
         * Hides or shows the color and font controls based on the selected mode
         * or if the passcode has been used.
         */
        function updateColorFontLockState() {
            const activeKey = getActiveHolidayKey();
            const colorFontControls = document.getElementById('colorFontControls');
            
            // Controls are visible (unlocked) if:
            // 1. The custom date tab is active (activeKey is 'custom_date'), OR
            // 2. The custom days passcode has been entered.
            const shouldBeVisible = activeKey === 'custom_date' || isPasscodeUnlocked;

            if (shouldBeVisible) {
                colorFontControls.classList.remove('hidden');
                colorFontControls.classList.remove('locked-controls');
            } else {
                colorFontControls.classList.add('hidden');
                colorFontControls.classList.add('locked-controls'); 
            }
        }

        /**
         * Switches the active tab and updates the application state, title, and default colors.
         * @param {string} mode The main mode key ('preset_holiday' or 'custom_date').
         */
        function switchTab(mode) {
            currentSelectionMode = mode;
            const allTabKeys = ['preset_holiday', 'custom_date']; // Only two main tabs now

            // 1. Update Tab Buttons UI
            allTabKeys.forEach(key => {
                const tabButton = document.getElementById(`tab-${key}`);
                if (!tabButton) return;
                
                if (key === mode) {
                    // Activate the selected tab with red styling
                    tabButton.classList.add('border-red-600', 'text-red-600');
                    tabButton.classList.remove('border-transparent', 'text-gray-500', 'hover:text-red-400');
                } else {
                    // Deactivate other tabs
                    tabButton.classList.remove('border-red-600', 'text-red-600');
                    tabButton.classList.add('border-transparent', 'text-gray-500', 'hover:text-red-400');
                }
            });

            // 2. Update Content Area Visibility and Defaults
            const presetContent = document.getElementById('content-preset_holiday');
            const customContent = document.getElementById('content-custom_date');
            
            if (mode === 'custom_date') {
                customContent.classList.remove('hidden');
                presetContent.classList.add('hidden');
                
                // Use the generic custom config defaults
                document.getElementById('countdownTitle').innerHTML = `CUSTOM COUNTDOWN Generator`;
                document.getElementById('custom-bg-color').value = HolidayConfigs.custom_date.defaultBg;
                document.getElementById('custom-number-color').value = HolidayConfigs.custom_date.defaultBorder;

            } else { // mode is 'preset_holiday'
                customContent.classList.add('hidden');
                presetContent.classList.remove('hidden');
                
                // Use the defaults of the currently selected holiday (currentHolidayKey)
                const config = HolidayConfigs[currentHolidayKey];
                document.getElementById('countdownTitle').innerHTML = `${config.title} Countdown Generator`;
                document.getElementById('custom-bg-color').value = config.defaultBg;
                document.getElementById('custom-number-color').value = config.defaultBorder;
            }
            
            // 3. Update Customization Lock State and Preview
            updateColorFontLockState();
            
            // 4. Reset and restart the live countdown for the new selection/mode
            if (countdownInterval) clearInterval(countdownInterval);
            updateLiveCountdown();
            countdownInterval = setInterval(updateLiveCountdown, 1000);

            updatePreviewSize();
        }

        /**
         * Handles the selection change from the holiday dropdown.
         * @param {string} newKey The key of the selected holiday (e.g., 'christmas').
         */
        function handleHolidaySelection(newKey) {
            currentHolidayKey = newKey;
            switchTab('preset_holiday'); // Force refresh the title, colors, and preview
        }

        /**
         * Handles the passcode entry logic.
         */
        function checkPasscode() {
            const passcode = document.getElementById('passcode-input').value;
            const customDaysContainer = document.getElementById('customDaysContainer');
            const unlockButton = document.querySelector('#passcode-input + button');
            
            if (passcode === SECRET_PASSCODE) {
                isPasscodeUnlocked = true; // Unlock the state
                
                customDaysContainer.classList.remove('hidden');
                document.getElementById('passcode-input').disabled = true;
                unlockButton.disabled = true;
                unlockButton.textContent = 'Unlocked!';
                unlockButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                unlockButton.classList.add('bg-green-500');

                // Unlock/show colors/fonts too
                updateColorFontLockState(); 
                updatePreviewSize(); 
            } else if (passcode !== "") {
                const input = document.getElementById('passcode-input');
                input.classList.remove('focus:border-red-500');
                input.classList.add('border-red-700', 'border-2');
                setTimeout(() => {
                    input.classList.remove('border-red-700', 'border-2');
                }, 500);
            }
        }
        
        // --- Core Application Functions ---

        /**
         * Draws the festive countdown text and graphics onto the canvas.
         */
        function drawHolidayCountdown(targetCtx, W, H) {
            const holidayKey = getActiveHolidayKey(); // Gets 'christmas' or 'custom_date' etc.
            const config = HolidayConfigs[holidayKey];
            const daysRemaining = calculateDaysUntilHoliday(); // Calls the function that respects the mode
            
            // --- Customization Overrides ---
            // If the controls are locked (hidden), we must use the holiday's default colors.
            const controlsLocked = holidayKey !== 'custom_date' && !isPasscodeUnlocked;

            const finalBg = controlsLocked ? config.defaultBg : document.getElementById('custom-bg-color').value;
            const finalBorder = controlsLocked ? config.defaultBorder : document.getElementById('custom-number-color').value;
            const finalFont = controlsLocked ? "'Mountains of Christmas', cursive" : document.getElementById('custom-font-select').value; 

            const centerX = W / 2;
            const centerY = H / 2;
            const minDim = Math.min(W, H);

            // --- Canvas Setup ---
            // 1. Background
            targetCtx.fillStyle = finalBg; 
            targetCtx.fillRect(0, 0, W, H);
            
            // 2. Decorative Border
            targetCtx.strokeStyle = finalBorder;
            targetCtx.lineWidth = minDim / 50; 
            targetCtx.strokeRect(targetCtx.lineWidth / 2, targetCtx.lineWidth / 2, W - targetCtx.lineWidth, H - targetCtx.lineWidth);

            // 3. Draw Static Snow Effect (Kept as white for all holidays for a decorative texture)
            for (let i = 0; i < 50; i++) {
                const x = Math.random() * W;
                const y = Math.random() * H;
                const radius = minDim / 300; 
                targetCtx.beginPath();
                targetCtx.arc(x, y, radius, 0, Math.PI * 2);
                targetCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                targetCtx.fill();
            }

            targetCtx.textAlign = 'center';
            targetCtx.shadowColor = 'transparent';
            targetCtx.shadowBlur = 0;

            
            // --- Text Drawing Logic ---
            let untilHolidayText = config.text;
            let holidayTitle = config.title;

            // Check for Custom Date label override (only applicable if 'custom_date' tab is active)
            if (holidayKey === 'custom_date') {
                const customLabelInput = document.getElementById('custom-target-date-label').value.toUpperCase().trim();
                if (customLabelInput) {
                    untilHolidayText = `UNTIL ${customLabelInput}!`;
                    holidayTitle = customLabelInput; // Use the custom label for the "HAPPY" message too
                }
            }


            if (daysRemaining <= 0) {
                // Special case for Holiday Day or after
                const holidayPassedText = daysRemaining === 0 ? `HAPPY ${holidayTitle}!` : `${holidayTitle} HAS PASSED!`;
                
                targetCtx.fillStyle = finalBorder; 
                const mainFontSize = minDim / 8;
                targetCtx.font = `900 ${mainFontSize}px ${finalFont}`;
                
                targetCtx.shadowColor = 'black'; 
                targetCtx.shadowBlur = minDim / 100;
                targetCtx.shadowOffsetX = minDim / 200;
                targetCtx.shadowOffsetY = minDim / 200;

                targetCtx.fillText(holidayPassedText, centerX, centerY + mainFontSize * 0.3);
                
            } else {
                // --- 3-Line Countdown Text ---
                
                const numberFontSize = minDim * 0.6;    
                const daysFontSize = minDim * 0.15;     
                const untilHolidayFontSize = minDim * 0.1; 

                const totalTextHeight = numberFontSize + daysFontSize + untilHolidayFontSize; 
                let currentY = centerY - (totalTextHeight / 2); 
                currentY += numberFontSize * 0.8; 

                // 1. TOP LINE: The number of days
                const numberText = `${daysRemaining}`;
                
                targetCtx.shadowColor = 'black'; 
                targetCtx.shadowBlur = minDim / 100;
                targetCtx.shadowOffsetX = minDim / 200;
                targetCtx.shadowOffsetY = minDim / 200;
                
                targetCtx.fillStyle = finalBorder; 
                targetCtx.font = `900 ${numberFontSize}px ${finalFont}`; 
                targetCtx.fillText(numberText, centerX, currentY);

                targetCtx.shadowColor = 'transparent'; // Reset shadow

                // 2. MIDDLE LINE: "DAYS"
                const daysText = daysRemaining === 1 ? "DAY" : "DAYS";
                currentY += daysFontSize * 1.25; 
                targetCtx.fillStyle = 'white';
                targetCtx.font = `900 ${daysFontSize}px ${finalFont}`;
                targetCtx.fillText(daysText, centerX, currentY);

                // 3. BOTTOM LINE: "UNTIL HOLIDAY!"
                currentY += untilHolidayFontSize * 1.4; 
                targetCtx.fillStyle = 'white';
                targetCtx.font = `bold ${untilHolidayFontSize}px ${finalFont}`; 
                targetCtx.fillText(untilHolidayText, centerX, currentY);
            }
        }

        /**
         * Updates the CSS aspect ratio of the preview container and redraws the canvas content.
         */
        function updatePreviewSize() {
            const resolutionValue = resolutionSelect.value;
            const [W_str, H_str] = resolutionValue.split('x');
            const W = parseInt(W_str);
            const H = parseInt(H_str);

            const container = document.getElementById('canvasContainer');
            
            container.style.aspectRatio = `${W} / ${H}`;
            
            const containerWidth = container.offsetWidth;
            const containerHeight = container.offsetHeight;
            canvas.width = containerWidth;
            canvas.height = containerHeight;
            drawHolidayCountdown(ctx, containerWidth, containerHeight);
        }


        /**
         * Downloads the generated canvas content based on selected resolution and file type.
         */
        function downloadImage() {
            const holidayKey = getActiveHolidayKey(); // Use the active key
            const config = HolidayConfigs[holidayKey];
            
            let filenameTitle = config.title;
            if (holidayKey === 'custom_date') {
                const customLabelInput = document.getElementById('custom-target-date-label').value.toUpperCase().trim();
                if (customLabelInput) {
                    filenameTitle = customLabelInput;
                }
            }


            const resolutionValue = resolutionSelect.value;
            const fileTypeValue = document.getElementById('filetype-select').value;
            
            const [W, H] = resolutionValue.split('x').map(s => parseInt(s));

            // Create a temporary high-resolution canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = W;
            tempCanvas.height = H;
            const tempCtx = tempCanvas.getContext('2d');

            // Draw the content onto the temporary canvas at high resolution
            drawHolidayCountdown(tempCtx, W, H);

            // Determine MIME type and file extension
            const mimeType = fileTypeValue === 'jpeg' ? 'image/jpeg' : 'image/png';
            const fileExtension = fileTypeValue === 'jpeg' ? 'jpg' : 'png';

            // Generate Filename
            const days = calculateDaysUntilHoliday(); // Use updated function
            const filenameBase = filenameTitle.replace(/\s+/g, '_').replace(/'/g, ''); 
            const filename = days <= 0 ? `${filenameBase}_Banner` : `${filenameBase}_Countdown_${days}_Days`;
            
            // Trigger Download
            const dataURL = tempCanvas.toDataURL(mimeType, 0.9); // 0.9 quality for JPEG
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = `${filename}_${W}x${H}.${fileExtension}`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            tempCanvas.remove();
        }

        /**
         * Toggles the visibility of the advanced options container.
         */
        function toggleAdvancedOptions() {
            const container = document.getElementById('advancedOptionsContainer');
            container.classList.toggle('hidden');
        }


        /**
         * Initializes the canvas and sets up the event listeners.
         */
        function initializeCanvas() {
            canvas = document.getElementById('countdownCanvas');
            ctx = canvas.getContext('2d');
            resolutionSelect = document.getElementById('resolution-select');
            customDaysInput = document.getElementById('custom-days-input');
            
            // 0. Populate the Holiday Select Dropdown
            const holidaySelect = document.getElementById('holiday-select');
            PRESET_HOLIDAY_KEYS.forEach(key => {
                const config = HolidayConfigs[key];
                const option = document.createElement('option');
                option.value = key;
                // Add friendly emoji/text for the options list
                let displayTitle = config.title;
                if (key === 'christmas') displayTitle = 'üéÑ Christmas';
                if (key === 'new_years') displayTitle = 'üéâ New Year\'s';
                if (key === 'halloween') displayTitle = 'üéÉ Halloween';
                if (key === 'valentines') displayTitle = 'üíñ Valentine\'s Day';
                if (key === 'thanksgiving') displayTitle = 'ü¶É Thanksgiving';
                if (key === 'wzyn_jubilee') displayTitle = '‚≠ê WZYN Jubilee';

                option.textContent = displayTitle;
                if (key === currentHolidayKey) {
                    option.selected = true;
                }
                holidaySelect.appendChild(option);
            });
            
            // Function to handle canvas resizing (affects the preview)
            const resizeCanvas = () => {
                const container = canvas.parentElement;
                canvas.width = container.offsetWidth;
                canvas.height = container.offsetHeight;
                
                // Redraw the content on resize
                drawHolidayCountdown(ctx, canvas.width, canvas.height);
            };

            // 1. Set up initial state: start on the 'preset_holiday' tab, showing 'christmas'
            switchTab('preset_holiday'); 
            
            // 2. Add listeners to update size when options change
            resolutionSelect.addEventListener('change', updatePreviewSize);
            
            // 3. Add listener to redraw on browser window resize
            window.addEventListener('resize', resizeCanvas);

            // 4. Add listeners to custom date inputs (only used when 'custom_date' tab is active)
            document.getElementById('custom-target-date').addEventListener('change', updatePreviewSize);
            document.getElementById('custom-target-date-label').addEventListener('input', updatePreviewSize);

            // 5. Start the live countdown timer
            updateLiveCountdown(); // Initial call
            countdownInterval = setInterval(updateLiveCountdown, 1000);
        }

        // Initialize the canvas and start drawing when the window loads
        window.onload = initializeCanvas;
    </script>
</body>
</html>
